<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>OSRS Item Data Display with Tabulator</title>
		<link href="https://cdn.jsdelivr.net/npm/tabulator-tables/dist/css/tabulator.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/tabulator-tables/dist/js/tabulator.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	</head>
	<body>
		<h1>OSRS Item Data</h1>
		<div id="data-table"></div>
		<!-- Container for Search Bar and Graph -->
		<div style="display: flex; justify-content: start; align-items: start; margin-top: 20px;">
			<!-- Search Box Container -->
			<div style="margin-right: 20px;">
				<input type="text" id="search-box" list="item-names" placeholder="Search items...">
				<datalist id="item-names"></datalist>
			</div>
			<!-- Graph Container -->
			<div style="flex-grow: 1; width: 600px; max-width: 90%; height: 600px;">
				<!-- Set a fixed height for the container -->
				<canvas id="itemHistoryGraph" style="width: 100%; height: 90%;"></canvas>
			</div>
		</div>
		<script>
			var table = new Tabulator("#data-table", {
			    height: "auto",
			    layout: "fitColumns",
			    pagination: "local",  // Enable local (client-side) pagination
			    paginationSize: 10,   // Number of items per page
			    data: {{ initial_data|safe }},  // Load initial data
			    columns: [
			        {title: "ID", field: "id"},
			        {title: "Name", field: "name"},
			        {title: "Last Updated", field: "last_updated"},
			        {title: "High Price", field: "price_high"},
			        {title: "Low Price", field: "price_low"},
			        {title: "Low Alch", field: "lowalch"},
			        {title: "High Alch", field: "highalch"},
			        {title: "Buy Limit", field: "buy_limit"},
			        {title: "Release Date", field: "release_date"},
			        {title: "Examine", field: "examine"},
			        {title: "Wiki URL", field: "wiki_url", formatter:"link", formatterParams: {
			            labelField:"wiki_url",
			            urlPrefix:"",
			            target:"_blank"
			        }},
			    ],
			});
			// Initialize Chart.js
			var ctx = document.getElementById('itemHistoryGraph').getContext('2d');
			var itemHistoryChart = new Chart(ctx, {
			    type: 'line',
			    data: {
			        labels: [],  // x-axis labels (e.g., dates)
			        datasets: [{
			            label: 'High Price',
			            backgroundColor: 'rgba(255, 99, 132, 0.2)',
			            borderColor: 'rgba(255, 99, 132, 1)',
			            data: []  // high price data
			        },
			        {
			            label: 'Low Price',
			            backgroundColor: 'rgba(54, 162, 235, 0.2)',
			            borderColor: 'rgba(54, 162, 235, 1)',
			            data: []  // low price data
			        }]
			},
			options: {
			    scales: {
			        yAxes: [{
			            ticks: {
			                beginAtZero: true
			            }
			        }]
			    }
			}
			});

			var lastSelectedItemId = null; // Variable to store the last selected item ID
			
			function loadItemNames() {
			    fetch('/static/item_names.json')
			        .then(response => {
			            if (!response.ok) {
			                throw new Error('Network response was not ok');
			            }
			            return response.json();
			        })
			        .then(data => {
			            var dataList = document.getElementById('item-names');
			            data.forEach(itemName => {
			                var option = document.createElement('option');
			                option.value = itemName;
			                dataList.appendChild(option);
			            });
			        })
			        .catch(error => {
			            console.error('Error loading item names:', error);
			        });
			    }
			
			loadItemNames();
			
			// Function to update the search
			function updateSearch() {
			    var searchTerm = document.getElementById('search-box').value;
			    table.setFilter("name", "like", searchTerm);
			}
			
			document.getElementById('search-box').addEventListener("input", updateSearch);
			
            function updateGraph(item_id) {
                lastSelectedItemId = item_id;
                fetch('/get-history/' + item_id)
                    .then(response => response.json())
                    .then(data => {
                        itemHistoryChart.data.labels = data.map(item => {
                            // Convert timestamp to a Date object
                            let date = new Date(item.timestamp);

                            // Adjust for local timezone
                            let localTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));

                            // Format the time in 12-hour format
                            let hours = localTime.getHours();
                            let minutes = localTime.getMinutes();
                            let ampm = hours >= 12 ? 'PM' : 'AM';
                            hours = hours % 12;
                            hours = hours ? hours : 12; // the hour '0' should be '12'
                            minutes = minutes < 10 ? '0' + minutes : minutes;
                            let strTime = hours + ':' + minutes + ' ' + ampm;

                            return strTime;
                        });

                        itemHistoryChart.data.datasets[0].data = data.map(item => item.price_high);
                        itemHistoryChart.data.datasets[1].data = data.map(item => item.price_low);
                        itemHistoryChart.update();
                    })
                    .catch(error => console.error('Error:', error));
            }

			table.on("cellClick", function(e, cell){
			    if(cell.getField() === "name") {
			        var item_id = cell.getRow().getData().id;
			        updateGraph(item_id);
			    }
			});
			
			function refreshData() {
			    var currentPage = table.getPage();
			    fetch('/get-data')
			        .then(response => response.json())
			        .then(data => {
			            table.setData(data)
			                .then(function(){
			                    table.setPage(currentPage);
			                });
			            if (lastSelectedItemId !== null) {
			                updateGraph(lastSelectedItemId);
			            }
			        })
			        .catch(error => console.error('Error:', error));
			}
			
			setInterval(refreshData, 60000); // Refresh data every 1 minutes
		</script>
	</body>
</html>